# BB-F1
- [BB-F1](#bb-f1)
  - [需求](#需求)
  - [硬件设计](#硬件设计)
  - [通讯协议](#通讯协议)
    - [协议简析](#协议简析)
    - [协议详析](#协议详析)


---
## 需求
1. 使用CAN网络与主控制器通讯  
2. 生成PWM控制弹舱盖舵机      PWM X4
3. 读取拨盘传感器反馈信号     ADC X1
4. PWM控制红点               PWM X1
5. 实现CAN转UART
---
## 硬件设计
 - STM32F103C6T6A
 - MAX3051KET6
 - TPS5430DDAR
 - RY8310
 - SK6014AS5-33

---
## 通讯协议
### 协议简析
- ID范围 0~2 
- CAN接收报文A标识符
  - 标准帧 | DATA | DLC==8
  - 标识符[ 0x400 + 5*ID ]  
- CAN接收报文B标识符
  - 标准帧 | DATA | DLC==3
  - 标识符[ 0x401 + 5*ID ]
- CAN接收报文C标识符
  - 标准帧 | DATA | DLC==8
  - 标识符[ 0x402 + 5*ID ]   
   
- CAN发送报文X标识符
  - 标准帧 | DATA | DLC==3
  - 标识符[ 0x403 + 5*ID ]
- CAN发送报文Y标识符
  - 标准帧 | DATA | DLC==8
  - 标识符[ 0x404 + 5*ID ]

### 协议详析
CAN接收报文A:
-  接收报文A用于控制四个舵机输出
-  时基20ms
-  值从499-2499控制高电平0.5ms-2.5ms, 传入其他值无效(保持上次有效值)

|CANID  | Data[00]    | Data[01]    | Data[02]    | Data[03]    | Data[04]    | Data[05]    | Data[06]    | Data[07]    |
|---------|------------|------------|------------|------------|------------|------------|------------|------------|
| HEAD | 舵机0_H | 舵机0_L | 舵机1_H | 舵机1_L | 舵机2_H | 舵机2_L | 舵机3_H | 舵机3_L |

CAN接收报文B:
-  接收报文B用于控制其他资源
-  激光0-1000控制5V可控输出占空比0-100%, 传入其他值无效(保持上次有效值)
-  CMD的数据位用于控制系统状态
   -  CMD[0:1] 值为1关闭舵机供电, 值为2开启舵机供电, 其他值保持
   -  CMD[2:2] 值为1重置拨盘计数值
  
|CANID  | Data[00]    | Data[01]    | Data[02]    |
|---------|------------|------------|------------|
| HEAD | 激光H | 激光L | CMD |

CAN接收报文C:
-  接收报文C用于CAN转串口通讯
-  数据将以115200波特率转发到串口

|CANID  | Data[00]    | Data[01]    | Data[02]    | Data[03]    | Data[04]    | Data[05]    | Data[06]    | Data[07]    |
|---------|------------|------------|------------|------------|------------|------------|------------|------------|
| HEAD | DATA0 | DATA1 | DATA2 | DATA3 | DATA4 | DATA5 | DATA6 | DATA7 |

CAN发送报文X:
-  接收报文X用于反馈系统状态
-  拨盘计数是记录的拨盘计数值
-  拨盘状态为1:拨盘位置未触发 2:拨盘位置已触发 3:传感器失效

|CANID  | Data[00]    | Data[01]    | Data[02]    |
|---------|------------|------------|------------|
| HEAD | 拨盘计数H | 拨盘计数L | 拨盘状态 |

CAN发送报文Y:
-  接收报文C用于串口转CAN
-  数据以115200波特率被接收, 并转发到CAN
-  一次仅能传输最多8个数据

|CANID  | Data[00]    | Data[01]    | Data[02]    | Data[03]    | Data[04]    | Data[05]    | Data[06]    | Data[07]    |
|---------|------------|------------|------------|------------|------------|------------|------------|------------|
| HEAD | DATA0 | DATA1 | DATA2 | DATA3 | DATA4 | DATA5 | DATA6 | DATA7 |